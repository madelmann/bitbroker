CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `v_market_ticker` AS with ticker as (select `market_ticker`.`id` AS `id`,`market_ticker`.`time` AS `time`,`market_ticker`.`instrument_code` AS `instrument_code`,`market_ticker`.`last_price` AS `last_price`,`market_ticker`.`best_ask` AS `best_ask`,`market_ticker`.`best_bid` AS `best_bid` from `market_ticker` group by `market_ticker`.`instrument_code` order by `market_ticker`.`time`)select `mt`.`id` AS `id`,`mt`.`time` AS `time`,`mt`.`instrument_code` AS `instrument_code`,`mt`.`last_price` AS `last_price`,max(`buy`.`price`) AS `best_ask`,min(`sell`.`price`) AS `best_bid` from ((`ticker` `mt` left join `orders` `buy` on(`buy`.`instrument_code` = `mt`.`instrument_code` and `buy`.`status_id` = 1 and `buy`.`side` = 'SELL')) left join `orders` `sell` on(`sell`.`instrument_code` = `mt`.`instrument_code` and `sell`.`status_id` = 1 and `sell`.`side` = 'BUY')) group by `mt`.`instrument_code`;