CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `v_orderbook_top3` AS (select `tmp_orders`.`id` AS `id`,`tmp_orders`.`order_id` AS `order_id`,`tmp_orders`.`account_id` AS `account_id`,`tmp_orders`.`status_id` AS `status_id`,`tmp_orders`.`instrument_code` AS `instrument_code`,`tmp_orders`.`type` AS `type`,`tmp_orders`.`side` AS `side`,`tmp_orders`.`amount` AS `amount`,`tmp_orders`.`filled_amount` AS `filled_amount`,`tmp_orders`.`price` AS `price`,`tmp_orders`.`created` AS `created`,`tmp_orders`.`last_modified` AS `last_modified`,`tmp_orders`.`finished` AS `finished` from (select `orders`.`id` AS `id`,`orders`.`order_id` AS `order_id`,`orders`.`account_id` AS `account_id`,`orders`.`status_id` AS `status_id`,`orders`.`instrument_code` AS `instrument_code`,`orders`.`type` AS `type`,`orders`.`side` AS `side`,sum(`orders`.`amount`) AS `amount`,sum(`orders`.`filled_amount`) AS `filled_amount`,`orders`.`price` AS `price`,`orders`.`created` AS `created`,`orders`.`last_modified` AS `last_modified`,`orders`.`finished` AS `finished` from `orders` where `orders`.`side` = 'BUY' and `orders`.`status_id` = 1 group by `orders`.`instrument_code`,`orders`.`price`) `tmp_orders` order by `tmp_orders`.`price` limit 3) union (select `tmp_orders`.`id` AS `id`,`tmp_orders`.`order_id` AS `order_id`,`tmp_orders`.`account_id` AS `account_id`,`tmp_orders`.`status_id` AS `status_id`,`tmp_orders`.`instrument_code` AS `instrument_code`,`tmp_orders`.`type` AS `type`,`tmp_orders`.`side` AS `side`,`tmp_orders`.`amount` AS `amount`,`tmp_orders`.`filled_amount` AS `filled_amount`,`tmp_orders`.`price` AS `price`,`tmp_orders`.`created` AS `created`,`tmp_orders`.`last_modified` AS `last_modified`,`tmp_orders`.`finished` AS `finished` from (select `orders`.`id` AS `id`,`orders`.`order_id` AS `order_id`,`orders`.`account_id` AS `account_id`,`orders`.`status_id` AS `status_id`,`orders`.`instrument_code` AS `instrument_code`,`orders`.`type` AS `type`,`orders`.`side` AS `side`,sum(`orders`.`amount`) AS `amount`,sum(`orders`.`filled_amount`) AS `filled_amount`,`orders`.`price` AS `price`,`orders`.`created` AS `created`,`orders`.`last_modified` AS `last_modified`,`orders`.`finished` AS `finished` from `orders` where `orders`.`side` = 'SELL' and `orders`.`status_id` = 1 group by `orders`.`instrument_code`,`orders`.`price`) `tmp_orders` order by `tmp_orders`.`price` desc limit 3);